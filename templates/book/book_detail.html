{% load static humanize %} 
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.title }} - BookStore</title>

    <!-- BASE -->
    <link rel="stylesheet" href="{% static 'base/header.css' %}">
    <link rel="stylesheet" href="{% static 'base/footer.css' %}">

    <!-- PAGE -->
    <link rel="stylesheet" href="{% static 'book/book_detail.css' %}">

</head>

<body>

{% include "base/header.html" %}

<main class="main-content">
    <div class="container">
        <div class="breadcrumb">
            <a href="{% url 'home:home' %}">Trang ch·ªß</a> &gt;
            <a href="{% url 'book:book_list' %}">S√°ch</a> &gt;
            <a href="{% url 'book:book_list' %}?category={{ book.category.id }}">
                {{ book.category.name }}
            </a>
            &gt;
            <span>{{ book.title }}</span>
        </div>
    </div>
    <div class="container">
        <div class="book-detail">

            <div class="book-main">
                <div class="book-image">
                    {% if book.images.first %}
                        <img src="{{ book.images.first.image }}" alt="{{ book.title }}">
                    {% else %}
                        <img src="https://via.placeholder.com/400x500?text=No+Image">
                    {% endif %}
                </div>

                <div class="book-info">
                    <h1>{{ book.title }}</h1>
                    <div class="book-author">T√°c gi·∫£: {{ book.author }}</div>

                    <div class="book-price">
                        {% if book.has_discount %}
                            <span class="sale-price">
                                {{ book.get_final_price_formatted }} ƒë
                            </span>
                            <span class="original-price">
                                {{ book.price|floatformat:0|intcomma }} ƒë
                            </span>
                        {% else %}
                            <span class="normal-price">
                                {{ book.price|floatformat:0|intcomma}} ƒë
                            </span>
                        {% endif %}
                    </div>

                    {% if book.stock > 0 %}
                        <span class="stock-status in-stock">
                            üì¶ C√≤n h√†ng ({{ book.stock }} s·∫£n ph·∫©m)
                        </span>
                    {% else %}
                        <span class="stock-status out-of-stock">
                            ‚ö†Ô∏è H·∫øt h√†ng
                        </span>
                    {% endif %}

                    <div class="book-meta">
                        <div class="meta-item">
                            üìÅ Danh m·ª•c: {{ book.category.name }}
                        </div>
                        <div class="meta-item">
                            üìÖ Xu·∫•t b·∫£n: {{ book.published_date|date:"d/m/Y" }}
                        </div>
                    </div>

                    <div class="action-buttons">
                        {% if book.stock > 0 %}
                        <form id="add-to-cart-form"
                            data-url="{% url 'cart:add_to_cart' book.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn-primary">
                                üõí Th√™m v√†o gi·ªè h√†ng
                            </button>
                        </form>
                        {% if user.is_authenticated %}
                        <form method="post" action="{% url 'book:toggle_favorite' book.id %}">
                            {% csrf_token %}
                            {% if is_favorite %}
                                <button type="submit" class="btn-secondary">
                                    ‚ù§Ô∏è B·ªè y√™u th√≠ch
                                </button>
                            {% else %}
                                <button type="submit" class="btn-secondary">
                                    ü§ç Th√™m v√†o y√™u th√≠ch
                                </button>
                            {% endif %}
                        </form>
                        {% endif %}

                        <p id="add-to-cart-message"
                            style="margin-top:10px;color:green;display:none;"></p>
                        {% else %}
                        <button class="btn-primary" disabled>H·∫øt h√†ng</button>
                        {% endif %}

                        <button class="btn-secondary"
                                onclick="location.href='{% url 'book:book_list' %}'">
                            ‚Üê Quay l·∫°i
                        </button>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">üìñ M√¥ t·∫£ s·∫£n ph·∫©m</h2>
                <div class="description">
                    {{ book.description|linebreaks }}
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">‚≠ê ƒê√°nh gi√° t·ª´ ƒë·ªôc gi·∫£</h2>
                <div class="reviews-container">
                    {% for review in book.reviews.all %}
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-user">
                                üë§ {{ review.user.username }}
                            </span>

                            <span class="review-rating">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        ‚≠ê
                                    {% else %}
                                        ‚òÜ
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </div>

                        <div class="review-content">
                            {{ review.comment }}
                        </div>

                        <div class="review-date">
                            {{ review.created_at|date:"d/m/Y H:i" }}
                        </div>
                    </div>

                    {% empty %}
                        <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
                    {% endfor %}
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">üìö S√°ch t∆∞∆°ng t·ª±</h2>

                <div class="books-grid">
                    {% for b in similar_books %}
                        <div class="book-card"
                            onclick="location.href='{% url 'book:book_detail' b.id %}'">
                            <div class="book-image">
                                {% if b.images.first %}
                                    <img src="{{ b.images.first.image }}">
                                {% else %}
                                    <img src="https://via.placeholder.com/200x300?text=No+Image">
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <div class="book-title">{{ b.title }}</div>
                                <div class="book-price">
                                    {{ b.get_display_price_formatted }} ƒë
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p>Ch∆∞a c√≥ s√°ch t∆∞∆°ng t·ª±.</p>
                    {% endfor %}
                </div>

                <div class="view-all">
                    <a href="{% url 'book:similar_books' book.id %}"
                        class="view-all-btn">
                            Xem t·∫•t c·∫£ s√°ch t∆∞∆°ng t·ª± ‚Üí
                    </a>
                </div>
            </div>

        </div>
    </div>

</main>

{% include "base/footer.html" %}

<script>
document.getElementById("add-to-cart-form")?.addEventListener("submit", function (e) {
    e.preventDefault();

    fetch(this.dataset.url, {
        method: "POST",
        headers: {
            "X-CSRFToken": this.querySelector("[name=csrfmiddlewaretoken]").value,
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const msg = document.getElementById("add-to-cart-message");
            msg.innerText = data.message;
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 2000);
        }
    });
});
</script>

</body>
</html>
