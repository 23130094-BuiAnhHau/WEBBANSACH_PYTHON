{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng -BookStore</title>
    <link rel="stylesheet" href="{% static 'cart/cart_detail.css' %}">
    <link rel="stylesheet" href="{% static 'home/home.css' %}">
</head>
<body>
    <!-- HEADER -->
<header class="header">

    <!-- TOP BAR -->
    <div class="header-top">
        <div class="header-container">

            <!-- LOGO -->
            <a href="{% url 'home:home' %}" class="logo">
                <div class="logo-text">BookStore</div>
            </a>

            <!-- SEARCH -->
            <form action="{% url 'book:book_list' %}" method="get" class="search-bar">
                <input
                    type="text"
                    name="search"
                    placeholder="T√¨m s√°ch, t√°c gi·∫£, th·ªÉ lo·∫°i..."
                    value="{{ request.GET.search|default:'' }}"
                >
                <button type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>

            <!-- ACTIONS -->
            <div class="header-actions">

                {% if user.is_authenticated %}
                    <span class="hello-user">
                        Xin ch√†o, <b>{{ user.username }}</b>
                    </span>

                    <!-- LOGOUT (POST) -->
                    <form action="{% url 'user:logout' %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="login-btn logout-btn">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </form>

                {% else %}
                    <a href="{% url 'user:login' %}" class="login-btn">
                        ƒêƒÉng nh·∫≠p
                    </a>
                {% endif %}

                <a href="{% url 'cart:cart_detail' %}" class="cart-btn">
                    <i class="fa-solid fa-cart-shopping"></i>
                    Gi·ªè h√†ng
                </a>

            </div>

        </div>
    </div>

    <!-- BOTTOM MENU -->
    <div class="header-bottom">
        <nav class="nav-links">
            <a href="{% url 'home:home' %}">Trang ch·ªß</a>
            <a href="{% url 'book:book_list' %}">S·∫£n ph·∫©m</a>
            <a href="{% url 'book:book_list' %}?sort=bestseller">B√°n ch·∫°y</a>
            <a href="{% url 'book:book_list' %}?sort=new">M·ªõi nh·∫•t</a>
        </nav>
    </div>

</header>

    <!-- Main Content -->
    <main class="container">
        <h1 class="page-title fade-in">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>
        
        <!-- Ki·ªÉm tra n·∫øu c√≥ gi·ªè h√†ng v√† c√≥ s·∫£n ph·∫©m -->
        {% if cart and cart.items.all %}
            <div class="cart-container fade-in">
                <!-- Cart Items -->
                <div class="cart-items">
                    <!-- Duy·ªát qua t·∫•t c·∫£ items trong gi·ªè h√†ng -->
                    {% for item in cart.items.all %}
                    <div class="cart-item" id="item-{{ item.id }}">
                        <div class="item-image">
                            <!-- Hi·ªÉn th·ªã ·∫£nh s√°ch (d√πng 30 ·∫£nh book1.jpg ƒë·∫øn book30.jpg) -->
                            {% with item.book.id|add:"-1"|divisibleby:"30"|add:"1" as image_num %}
                            <img src="/media/book_covers/book{{ image_num }}.jpg" 
                                 alt="{{ item.book.title }}"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/100x120/2e7d32/ffffff?text={{ item.book.title|slice:":10" }}'">
                            {% endwith %}
                        </div>
                        
                        <div class="item-info">
                            <h3 class="item-title">{{ item.book.title }}</h3>
                            <p class="item-author">T√°c gi·∫£: {{ item.book.author }}</p>
                            <div class="item-price vnd-format">
                                {{ item.price|floatformat:0 }}
                            </div>
                        </div>
                        
                        <div class="item-actions">
                            <!-- Quantity control -->
                            <div class="quantity-control">
                                <form method="POST" action="{% url 'cart:decrease_quantity' item.id %}" 
                                      class="update-form" data-item-id="{{ item.id }}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="button" class="quantity-btn decrease-btn">-</button>
                                </form>
                                
                                <span class="quantity" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                                
                                <form method="POST" action="{% url 'cart:add_to_cart' item.book.id %}" 
                                      class="update-form" data-item-id="{{ item.id }}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="button" class="quantity-btn increase-btn">+</button>
                                </form>
                            </div>
                            
                            <!-- Total price for this item -->
                            <div class="item-total vnd-format" id="total-{{ item.id }}">
                                {{ item.get_total_price|floatformat:0 }}
                            </div>
                            
                            <!-- Remove button -->
                            <form method="POST" action="{% url 'cart:remove_from_cart' item.id %}" 
                                  class="remove-form" data-item-id="{{ item.id }}">
                                {% csrf_token %}
                                <button type="button" class="remove-btn">
                                    üóëÔ∏è X√≥a s·∫£n ph·∫©m
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Cart Summary -->
                <div class="cart-summary">
                    <h2 class="summary-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h2>
                    
                    <div class="summary-row">
                        <span>T·∫°m t√≠nh:</span>
                        <span class="vnd-format" id="cart-subtotal">
                            {{ cart.total_price|floatformat:0 }}
                        </span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <span class="vnd-format">0</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Gi·∫£m gi√°:</span>
                        <span class="vnd-format">0</span>
                    </div>
                    
                    <div class="summary-total">
                        <span>T·ªïng c·ªông:</span>
                        <span class="vnd-format" id="cart-total">
                            {{ cart.total_price|floatformat:0 }}
                        </span>
                    </div>
                    
                    <button class="checkout-btn" id="checkout-btn">
                        üöÄ Ti·∫øn h√†nh ƒë·∫∑t h√†ng
                    </button>
                    
                    <button class="continue-btn" onclick="window.location.href='{% url 'book_list' %}'">
                        ‚Üê Ti·∫øp t·ª•c mua s·∫Øm
                    </button>
                    
                    <div style="margin-top: 20px; font-size: 14px; color: #718096; text-align: center;">
                        <p>Thanh to√°n an to√†n | Giao h√†ng mi·ªÖn ph√≠ | ƒê·ªïi tr·∫£ d·ªÖ d√†ng</p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Empty Cart -->
            <div class="empty-cart fade-in">
                <div class="empty-icon">üõí</div>
                <h2 class="empty-title">Gi·ªè h√†ng tr·ªëng</h2>
                <p class="empty-text">
                    B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.<br>
                    H√£y kh√°m ph√° nh·ªØng cu·ªën s√°ch hay nh·∫•t t·∫°i Minh Long Book!
                </p>
                <a href="{% url 'book:book_list' %}" class="shop-btn">Mua s·∫Øm ngay</a>
                
                <div style="margin-top: 40px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <a href="{% url 'book:book_list' %}?sort=new" style="text-decoration: none; color: inherit;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üìö</div>
                            <div style="font-weight: 500;">S√°ch m·ªõi nh·∫•t</div>
                        </div>
                    </a>
                    <a href="{% url 'book:book_list' %}?sort=bestseller" style="text-decoration: none; color: inherit;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üî•</div>
                            <div style="font-weight: 500;">B√°n ch·∫°y nh·∫•t</div>
                        </div>
                    </a>
                    <a href="{% url 'book:book_list' %}?category=1" style="text-decoration: none; color: inherit;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚≠ê</div>
                            <div style="font-weight: 500;">VƒÉn h·ªçc</div>
                        </div>
                    </a>
                </div>
            </div>
        {% endif %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <p>¬© 2024 BookStore. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>

    <script>
        // CSRF token helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Format s·ªë th√†nh VND
        function formatVND(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ‚Ç´';
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
        async function updateQuantity(itemId, change) {
            const quantityElement = document.getElementById(`quantity-${itemId}`);
            const totalElement = document.getElementById(`total-${itemId}`);
            const btn = event.target;
            
            let currentQuantity = parseInt(quantityElement.textContent);
            let newQuantity = currentQuantity + change;
            
            if (newQuantity < 1) return;
            
            // Hi·ªÉn th·ªã loading
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div>';
            
            try {
                // G·ª≠i request c·∫≠p nh·∫≠t
                const formData = new FormData();
                formData.append('quantity', newQuantity);
                
                const response = await fetch(`/cart/update/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData
                });
                
                if (response.ok) {
                    // C·∫≠p nh·∫≠t UI
                    quantityElement.textContent = newQuantity;
                    
                    // Gi·∫£ s·ª≠ m·ªói s·∫£n ph·∫©m gi√° 100.000ƒë ƒë·ªÉ t√≠nh t·ªïng (trong th·ª±c t·∫ø s·∫Ω l·∫•y t·ª´ response)
                    const itemPrice = 100000; // ƒê√¢y l√† gi√° m·∫´u
                    const newTotal = itemPrice * newQuantity;
                    totalElement.textContent = formatVND(newTotal);
                    
                    // C·∫≠p nh·∫≠t t·ªïng gi·ªè h√†ng
                    updateCartTotal();
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
            } finally {
                // Kh√¥i ph·ª•c button
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // X√≥a s·∫£n ph·∫©m
        async function removeItem(itemId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')) {
                return;
            }
            
            const btn = event.target;
            const itemElement = document.getElementById(`item-${itemId}`);
            
            // Hi·ªÉn th·ªã loading
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div>';
            
            try {
                const response = await fetch(`/cart/remove/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    // X√≥a item kh·ªèi UI
                    itemElement.style.opacity = '0';
                    itemElement.style.transform = 'translateX(-50px)';
                    itemElement.style.transition = 'all 0.3s';
                    
                    setTimeout(() => {
                        itemElement.remove();
                        updateCartTotal();
                        
                        // Ki·ªÉm tra n·∫øu gi·ªè h√†ng tr·ªëng
                        if (document.querySelectorAll('.cart-item').length === 0) {
                            location.reload(); // Reload ƒë·ªÉ hi·ªÉn th·ªã empty cart
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a s·∫£n ph·∫©m');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // C·∫≠p nh·∫≠t t·ªïng gi·ªè h√†ng (gi·∫£ s·ª≠)
        function updateCartTotal() {
            // Trong th·ª±c t·∫ø, s·∫Ω g·ªçi API ƒë·ªÉ l·∫•y t·ªïng m·ªõi
            // ·ªû ƒë√¢y gi·∫£ s·ª≠ t√≠nh t·ªïng t·ª´ t·∫•t c·∫£ items
            let subtotal = 0;
            document.querySelectorAll('.item-total').forEach(el => {
                const totalText = el.textContent.replace(/[^\d]/g, '');
                subtotal += parseInt(totalText) || 0;
            });
            
            document.getElementById('cart-subtotal').textContent = formatVND(subtotal);
            document.getElementById('cart-total').textContent = formatVND(subtotal);
        }

        // Thanh to√°n
        document.getElementById('checkout-btn')?.addEventListener('click', function() {
            alert('ƒë√¢y s·∫Ω l√† trang x√°c nh·∫≠n ƒë∆°n h√†ng.');
        });

        // Event listeners cho c√°c buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Increase buttons
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.closest('.update-form').dataset.itemId;
                    updateQuantity(itemId, 1);
                });
            });
            
            // Decrease buttons
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.closest('.update-form').dataset.itemId;
                    updateQuantity(itemId, -1);
                });
            });
            
            // Remove buttons
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.closest('.remove-form').dataset.itemId;
                    removeItem(itemId);
                });
            });
            
            // Format t·∫•t c·∫£ gi√° ti·ªÅn
            document.querySelectorAll('.vnd-format').forEach(el => {
                const number = parseInt(el.textContent.replace(/[^\d]/g, ''));
                if (!isNaN(number)) {
                    el.textContent = formatVND(number);
                }
            });
            
            // Animation cho cart items
            document.querySelectorAll('.cart-item').forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    item.style.transition = 'all 0.5s ease';
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>