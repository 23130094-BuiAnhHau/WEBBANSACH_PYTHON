{% load static humanize %} 
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>BookStore - Thanh toán thất bại</title>

    <!-- Base -->
    <link rel="stylesheet" href="{% static 'base/header.css' %}">
    <link rel="stylesheet" href="{% static 'base/footer.css' %}">

    <!-- Page CSS -->
    <link rel="stylesheet" href="{% static 'order/payment_failed.css' %}">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<!-- HEADER -->
{% include "base/header.html" %}

<!-- MAIN giống home -->
<main class="main-content">

    <div class="confirmation-container">

        <!-- FAILED CARD -->
        <div class="card failed-card">
            <i class="fa-solid fa-circle-xmark"></i>
            <h1>THANH TOÁN THẤT BẠI!</h1>

            <p>
                Rất tiếc, giao dịch của bạn không thành công.
                Vui lòng kiểm tra lại thông tin hoặc thử phương thức thanh toán khác.
            </p>

            <p>
                Mã đơn hàng tạm thời:
                <strong>#DH{{ order.id }}</strong>
            </p>

            <p class="error-message">
                Lý do:
                {{ order.failure_reason|default:"Thẻ không hợp lệ hoặc lỗi kết nối cổng thanh toán." }}
            </p>

            <div class="confirmation-actions">
                <a href="{% url 'order:checkout_retry' pk=order.id %}"
                   class="order-btn primary-failed-btn">
                    Thử lại Thanh toán
                </a>
                <a href="{% url 'cart:cart_detail' %}"
                   class="order-btn secondary-btn">
                    Quay lại Giỏ hàng
                </a>
            </div>
        </div>

        <!-- ORDER SUMMARY -->
        <div class="card">
            <h2>Tóm tắt đơn hàng</h2>

            <div class="summary-details">
                <div class="detail-row">
                    <strong>Ngày đặt:</strong>
                    <span>{{ order.created_at|date:"d/m/Y" }}</span>
                </div>
                <div class="detail-row">
                    <strong>Phương thức thanh toán:</strong>
                    <span>{{ order.get_payment_method_display }}</span>
                </div>
                <div class="detail-row">
                    <strong>Địa chỉ giao hàng:</strong>
                    <span>{{ order.shipping_address }}</span>
                </div>
            </div>

            <div class="summary-row">
                <span>Tạm tính</span>
                <span>{{ raw_total|floatformat:0 }}₫</span>
            </div>

            <div class="summary-row">
                <span>Phí vận chuyển</span>
                <span>{{ order.shipping_fee|default:15000|floatformat:0 }}₫</span>
            </div>

            <div class="summary-row discount-row">
                <span>Giảm giá</span>
                <span>- {{ order.discount_amount|default:0|floatformat:0 }}₫</span>
            </div>

            <div class="summary-row total">
                <strong>TỔNG THANH TOÁN:</strong>
                <strong>{{ final_total|floatformat:0 }}₫</strong>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div class="card">
            <h3>Sản phẩm đã đặt</h3>

            {% for item in order.items.all %}
            <div class="product">
                <img
                    src="{% if item.book.images.first %}
                            {{ item.book.images.first.image.url }}
                         {% else %}
                            https://via.placeholder.com/60
                         {% endif %}"
                    class="product-img"
                >

                <div class="product-right">
                    <p class="product-title">{{ item.book.title }}</p>
                    <div class="product-bottom">
                        <strong>{{ final_total|floatformat:0|intcomma}}₫</strong>
                        <span>x {{ item.quantity }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</main>

<!-- FOOTER -->
{% include "base/footer.html" %}

</body>
</html>
